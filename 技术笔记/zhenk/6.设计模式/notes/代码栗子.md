# 享元模式
**享元模式就是把一个个共同特性的对象以一个对象封装到一个池中共同使用**
## 渲染一片森林
> [!TIPS] 简介
> * 本例中， 我们将渲染一片森林 （1,000,000 棵树）！ 每棵树都由包含一些状态的对象来表示 （坐标和纹理等）。 尽管程序能够完成其主要工作， 但很显然它需要消耗大量内存。
> * 原因很简单： 太多树对象包含重复数据 （名称、 纹理和颜色）。 因此我们可用享元模式来将这些数值存储在单独的享元对象中 （ `Tree­Type`类）。 现在我们不再将相同数据存储在数千个 `Tree`对象中， 而是使用一组特殊的数值来引用其中一个享元对象。
> * 客户端代码不会知道任何事情， 因为重用享元对象的复杂机制隐藏在了享元工厂中。

###  trees
#### 1.Tree.java
包含每棵树的独特状态
```java
import java.awt.*;  
  
/**  
 * 包含每棵树的独特状态  
 *  
 * @author Administrator  
 */
 public class Tree {  
    private int x;  
    private int y;  
    private TreeType type;  
  
    public Tree(int x, int y, TreeType type) {  
        this.x = x;  
        this.y = y;  
        this.type = type;  
    }  
  
    public void draw(Graphics g) {  
        type.draw(g, x, y);  
    }  
}
```
#### 2.TreeType.java
包含多棵树共享的状态
```java
import java.awt.*;  
  
/**  
 * 包含多棵树共享的状态  
 * 将这些数值(太多树对象包含重复数据 （名称、 纹理和颜色）)存储在单独的享元对象中 （ TreeType类）  
 *  
 * @author Administrator  
 */
 public class TreeType {  
    private String name;  
    private Color color;  
    private String otherTreeData;  
  
    public TreeType(String name, Color color, String otherTreeData) {  
        this.name = name;  
        this.color = color;  
        this.otherTreeData = otherTreeData;  
    }  
  
    public void draw(Graphics g, int x, int y) {  
        g.setColor(Color.BLACK);  
        g.fillRect(x - 1, y, 3, 5);  
        g.setColor(color);  
        g.fillOval(x - 5, y - 10, 10, 10);  
    }  
}
```

#### 3.TreeFactory.java
封装创建享元的复杂机制
```java
import java.awt.*;  
import java.util.HashMap;  
import java.util.Map;  
  
/**  
 * 封装创建享元的复杂机制  
 *  
 * @author Administrator  
 */
 public class TreeFactory {  
    static Map<String, TreeType> treeTypes = new HashMap<>();  
  
    public static TreeType getTreeType(String name, Color color, String otherTreeData) {  
        TreeType result = treeTypes.get(name);  
        if (result == null) {  
            result = new TreeType(name, color, otherTreeData);  
            treeTypes.put(name, result);  
        }  
        return result;  
    }  
}
```

### forest
#### 1.Forest.java
我们绘制的森林
```java
/**  
 * 我们绘制的森林  
 *  
 * @author Administrator  
 */
 public class Forest extends JFrame {  
    private List<Tree> trees = new ArrayList<>();  
  
    public void plantTree(int x, int y, String name, Color color, String otherTreeData) {  
        TreeType type = TreeFactory.getTreeType(name, color, otherTreeData);  
        Tree tree = new Tree(x, y, type);  
        trees.add(tree);  
    }  
  
    @Override  
    public void paint(Graphics graphics) {  
        for (Tree tree : trees) {  
            tree.draw(graphics);  
        }  
    }  
}
```

### DemoClient.java
客户端代码
```java
/**  
 * 客户端代码  
 *  
 * @author Administrator  
 */
 public class DemoClient {  
    static int CANVAS_SIZE = 500;  
    static int TREES_TO_DRAW = 1000000;  
    static int TREE_TYPES = 2;  
  
    public static void main(String[] args) {  
        Forest forest = new Forest();  
        for (int i = 0; i < Math.floor(TREES_TO_DRAW / TREE_TYPES); i++) {  
            forest.plantTree(random(0, CANVAS_SIZE), random(0, CANVAS_SIZE),  
                    "Summer Oak", Color.GREEN, "Oak texture stub");  
            forest.plantTree(random(0, CANVAS_SIZE), random(0, CANVAS_SIZE),  
                    "Autumn Oak", Color.ORANGE, "Autumn Oak texture stub");  
        }  
        forest.setSize(CANVAS_SIZE, CANVAS_SIZE);  
        forest.setVisible(true);  
  
        System.out.println(TREES_TO_DRAW + " trees drawn");  
        System.out.println("---------------------");  
        System.out.println("Memory usage:");  
        System.out.println("Tree size (8 bytes) * " + TREES_TO_DRAW);  
        System.out.println("+ TreeTypes size (~30 bytes) * " + TREE_TYPES + "");  
        System.out.println("---------------------");  
        System.out.println("Total: " + ((TREES_TO_DRAW * 8 + TREE_TYPES * 30) / 1024 / 1024) +  
                "MB (instead of " + ((TREES_TO_DRAW * 38) / 1024 / 1024) + "MB)");  
    }  
  
    private static int random(int min, int max) {  
        return min + (int) (Math.random() * ((max - min) + 1));  
    }  
}
```



# 迭代器模式
**在不暴露复杂数据结构内部细节的情况下遍历其中所有的元素**
## 迭代访问社交网络档案
在本例中， 迭代器模式被用于在不向客户端代码暴露通信细节的情况下访问远程社交网络集合中的社交媒体档案。
“好友 （friends）” 迭代器可用于遍历指定档案的好友。 ​ “同事 （colleagues）” 迭代器也提供同样的功能， 但仅包括与目标用户在同一家公司工作的好友。 这两个迭代器都实现了同一个通用接口， 客户端能在不了解认证和发送 REST 请求等实现细节的情况下获取档案。

客户端仅通过接口与集合和迭代器交互， 也就不会同具体类耦合。 如果你决定将应用连接到全新的社交网络， 只需提供新的集合和迭代器类即可， 无需修改现有代码。
![[迭代访问社交网络档案.png]]



### iterators
#### 1.ProfileIterator.java
定义档案接口
```java
import refactoring_guru.iterator.example.profile.Profile;
public interface ProfileIterator {
    boolean hasNext();
    Profile getNext();
    void reset();
}
```

#### 2.FacebookIterator.java
在 Facebook 档案上实现迭代
```java
import refactoring_guru.iterator.example.profile.Profile;
import refactoring_guru.iterator.example.social_networks.Facebook;

import java.util.ArrayList;
import java.util.List;

public class FacebookIterator implements ProfileIterator {
    private Facebook facebook;
    private String type;
    private String email;
    private int currentPosition = 0;
    private List<String> emails = new ArrayList<>();
    private List<Profile> profiles = new ArrayList<>();

    public FacebookIterator(Facebook facebook, String type, String email) {
        this.facebook = facebook;
        this.type = type;
        this.email = email;
    }

    private void lazyLoad() {
        if (emails.size() == 0) {
            List<String> profiles = facebook.requestProfileFriendsFromFacebook(this.email, this.type);
            for (String profile : profiles) {
                this.emails.add(profile);
                this.profiles.add(null);
            }
        }
    }

    @Override
    public boolean hasNext() {
        lazyLoad();
        return currentPosition < emails.size();
    }

    @Override
    public Profile getNext() {
        if (!hasNext()) {
            return null;
        }

        String friendEmail = emails.get(currentPosition);
        Profile friendProfile = profiles.get(currentPosition);
        if (friendProfile == null) {
            friendProfile = facebook.requestProfileFromFacebook(friendEmail);
            profiles.set(currentPosition, friendProfile);
        }
        currentPosition++;
        return friendProfile;
    }

    @Override
    public void reset() {
        currentPosition = 0;
    }
}
```

#### 3.LinkedInIterator.java
在领英档案上实现迭代
```java
import refactoring_guru.iterator.example.profile.Profile;
import refactoring_guru.iterator.example.social_networks.LinkedIn;

import java.util.ArrayList;
import java.util.List;

public class LinkedInIterator implements ProfileIterator {
    private LinkedIn linkedIn;
    private String type;
    private String email;
    private int currentPosition = 0;
    private List<String> emails = new ArrayList<>();
    private List<Profile> contacts = new ArrayList<>();

    public LinkedInIterator(LinkedIn linkedIn, String type, String email) {
        this.linkedIn = linkedIn;
        this.type = type;
        this.email = email;
    }

    private void lazyLoad() {
        if (emails.size() == 0) {
            List<String> profiles = linkedIn.requestRelatedContactsFromLinkedInAPI(this.email, this.type);
            for (String profile : profiles) {
                this.emails.add(profile);
                this.contacts.add(null);
            }
        }
    }

    @Override
    public boolean hasNext() {
        lazyLoad();
        return currentPosition < emails.size();
    }

    @Override
    public Profile getNext() {
        if (!hasNext()) {
            return null;
        }

        String friendEmail = emails.get(currentPosition);
        Profile friendContact = contacts.get(currentPosition);
        if (friendContact == null) {
            friendContact = linkedIn.requestContactInfoFromLinkedInAPI(friendEmail);
            contacts.set(currentPosition, friendContact);
        }
        currentPosition++;
        return friendContact;
    }

    @Override
    public void reset() {
        currentPosition = 0;
    }
}
```

### social_networks
#### 1.SocialNetwork.java
定义通用的社交网络接口
```java
import refactoring_guru.iterator.example.iterators.ProfileIterator;

public interface SocialNetwork {
    ProfileIterator createFriendsIterator(String profileEmail);

    ProfileIterator createCoworkersIterator(String profileEmail);
}
```

#### 2.Facebook.java
```java
import refactoring_guru.iterator.example.iterators.FacebookIterator;
import refactoring_guru.iterator.example.iterators.ProfileIterator;
import refactoring_guru.iterator.example.profile.Profile;

import java.util.ArrayList;
import java.util.List;

public class Facebook implements SocialNetwork {
    private List<Profile> profiles;

    public Facebook(List<Profile> cache) {
        if (cache != null) {
            this.profiles = cache;
        } else {
            this.profiles = new ArrayList<>();
        }
    }

    public Profile requestProfileFromFacebook(String profileEmail) {
        // Here would be a POST request to one of the Facebook API endpoints.
        // Instead, we emulates long network connection, which you would expect
        // in the real life...
        simulateNetworkLatency();
        System.out.println("Facebook: Loading profile '" + profileEmail + "' over the network...");

        // ...and return test data.
        return findProfile(profileEmail);
    }

    public List<String> requestProfileFriendsFromFacebook(String profileEmail, String contactType) {
        // Here would be a POST request to one of the Facebook API endpoints.
        // Instead, we emulates long network connection, which you would expect
        // in the real life...
        simulateNetworkLatency();
        System.out.println("Facebook: Loading '" + contactType + "' list of '" + profileEmail + "' over the network...");

        // ...and return test data.
        Profile profile = findProfile(profileEmail);
        if (profile != null) {
            return profile.getContacts(contactType);
        }
        return null;
    }

    private Profile findProfile(String profileEmail) {
        for (Profile profile : profiles) {
            if (profile.getEmail().equals(profileEmail)) {
                return profile;
            }
        }
        return null;
    }

    private void simulateNetworkLatency() {
        try {
            Thread.sleep(2500);
        } catch (InterruptedException ex) {
            ex.printStackTrace();
        }
    }

    @Override
    public ProfileIterator createFriendsIterator(String profileEmail) {
        return new FacebookIterator(this, "friends", profileEmail);
    }

    @Override
    public ProfileIterator createCoworkersIterator(String profileEmail) {
        return new FacebookIterator(this, "coworkers", profileEmail);
    }

}
```

#### 3.LinkedIn.java
领英
```java
import refactoring_guru.iterator.example.iterators.LinkedInIterator;
import refactoring_guru.iterator.example.iterators.ProfileIterator;
import refactoring_guru.iterator.example.profile.Profile;

import java.util.ArrayList;
import java.util.List;

public class LinkedIn implements SocialNetwork {
    private List<Profile> contacts;

    public LinkedIn(List<Profile> cache) {
        if (cache != null) {
            this.contacts = cache;
        } else {
            this.contacts = new ArrayList<>();
        }
    }

    public Profile requestContactInfoFromLinkedInAPI(String profileEmail) {
        // Here would be a POST request to one of the LinkedIn API endpoints.
        // Instead, we emulates long network connection, which you would expect
        // in the real life...
        simulateNetworkLatency();
        System.out.println("LinkedIn: Loading profile '" + profileEmail + "' over the network...");

        // ...and return test data.
        return findContact(profileEmail);
    }

    public List<String> requestRelatedContactsFromLinkedInAPI(String profileEmail, String contactType) {
        // Here would be a POST request to one of the LinkedIn API endpoints.
        // Instead, we emulates long network connection, which you would expect
        // in the real life.
        simulateNetworkLatency();
        System.out.println("LinkedIn: Loading '" + contactType + "' list of '" + profileEmail + "' over the network...");

        // ...and return test data.
        Profile profile = findContact(profileEmail);
        if (profile != null) {
            return profile.getContacts(contactType);
        }
        return null;
    }

    private Profile findContact(String profileEmail) {
        for (Profile profile : contacts) {
            if (profile.getEmail().equals(profileEmail)) {
                return profile;
            }
        }
        return null;
    }

    private void simulateNetworkLatency() {
        try {
            Thread.sleep(2500);
        } catch (InterruptedException ex) {
            ex.printStackTrace();
        }
    }

    @Override
    public ProfileIterator createFriendsIterator(String profileEmail) {
        return new LinkedInIterator(this, "friends", profileEmail);
    }

    @Override
    public ProfileIterator createCoworkersIterator(String profileEmail) {
        return new LinkedInIterator(this, "coworkers", profileEmail);
    }
}
```

### profile
#### 1.Profile.java
社交档案
```java
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

public class Profile {
    private String name;
    private String email;
    private Map<String, List<String>> contacts = new HashMap<>();

    public Profile(String email, String name, String... contacts) {
        this.email = email;
        this.name = name;

        // Parse contact list from a set of "friend:email@gmail.com" pairs.
        for (String contact : contacts) {
            String[] parts = contact.split(":");
            String contactType = "friend", contactEmail;
            if (parts.length == 1) {
                contactEmail = parts[0];
            }
            else {
                contactType = parts[0];
                contactEmail = parts[1];
            }
            if (!this.contacts.containsKey(contactType)) {
                this.contacts.put(contactType, new ArrayList<>());
            }
            this.contacts.get(contactType).add(contactEmail);
        }
    }

    public String getEmail() {
        return email;
    }

    public String getName() {
        return name;
    }

    public List<String> getContacts(String contactType) {
        if (!this.contacts.containsKey(contactType)) {
            this.contacts.put(contactType, new ArrayList<>());
        }
        return contacts.get(contactType);
    }
}
```

### spammer
#### 1.SocialSpammer.java
消息发送应用
```java 
import refactoring_guru.iterator.example.iterators.ProfileIterator;
import refactoring_guru.iterator.example.profile.Profile;
import refactoring_guru.iterator.example.social_networks.SocialNetwork;

public class SocialSpammer {
    public SocialNetwork network;
    public ProfileIterator iterator;

    public SocialSpammer(SocialNetwork network) {
        this.network = network;
    }

    public void sendSpamToFriends(String profileEmail, String message) {
        System.out.println("\nIterating over friends...\n");
        iterator = network.createFriendsIterator(profileEmail);
        while (iterator.hasNext()) {
            Profile profile = iterator.getNext();
            sendMessage(profile.getEmail(), message);
        }
    }

    public void sendSpamToCoworkers(String profileEmail, String message) {
        System.out.println("\nIterating over coworkers...\n");
        iterator = network.createCoworkersIterator(profileEmail);
        while (iterator.hasNext()) {
            Profile profile = iterator.getNext();
            sendMessage(profile.getEmail(), message);
        }
    }

    public void sendMessage(String email, String message) {
        System.out.println("Sent message to: '" + email + "'. Message body: '" + message + "'");
    }
}
```

### **Demo.java:** 客户端代码
```java
import refactoring_guru.iterator.example.profile.Profile;
import refactoring_guru.iterator.example.social_networks.Facebook;
import refactoring_guru.iterator.example.social_networks.LinkedIn;
import refactoring_guru.iterator.example.social_networks.SocialNetwork;
import refactoring_guru.iterator.example.spammer.SocialSpammer;

import java.util.ArrayList;
import java.util.List;
import java.util.Scanner;

/**
 * Demo class. Everything comes together here.
 */
public class Demo {
    public static Scanner scanner = new Scanner(System.in);

    public static void main(String[] args) {
        System.out.println("Please specify social network to target spam tool (default:Facebook):");
        System.out.println("1. Facebook");
        System.out.println("2. LinkedIn");
        String choice = scanner.nextLine();

        SocialNetwork network;
        if (choice.equals("2")) {
            network = new LinkedIn(createTestProfiles());
        }
        else {
            network = new Facebook(createTestProfiles());
        }

        SocialSpammer spammer = new SocialSpammer(network);
        spammer.sendSpamToFriends("anna.smith@bing.com",
                "Hey! This is Anna's friend Josh. Can you do me a favor and like this post [link]?");
        spammer.sendSpamToCoworkers("anna.smith@bing.com",
                "Hey! This is Anna's boss Jason. Anna told me you would be interested in [link].");
    }

    public static List<Profile> createTestProfiles() {
        List<Profile> data = new ArrayList<Profile>();
        data.add(new Profile("anna.smith@bing.com", "Anna Smith", "friends:mad_max@ya.com", "friends:catwoman@yahoo.com", "coworkers:sam@amazon.com"));
        data.add(new Profile("mad_max@ya.com", "Maximilian", "friends:anna.smith@bing.com", "coworkers:sam@amazon.com"));
        data.add(new Profile("bill@microsoft.eu", "Billie", "coworkers:avanger@ukr.net"));
        data.add(new Profile("avanger@ukr.net", "John Day", "coworkers:bill@microsoft.eu"));
        data.add(new Profile("sam@amazon.com", "Sam Kitting", "coworkers:anna.smith@bing.com", "coworkers:mad_max@ya.com", "friends:catwoman@yahoo.com"));
        data.add(new Profile("catwoman@yahoo.com", "Liza", "friends:anna.smith@bing.com", "friends:sam@amazon.com"));
        return data;
    }
}
```

### **OutputDemo.txt:** 执行结果
```txt
Please specify social network to target spam tool (default:Facebook):
1. Facebook
2. LinkedIn
> 1

Iterating over friends...

Facebook: Loading 'friends' list of 'anna.smith@bing.com' over the network...
Facebook: Loading profile 'mad_max@ya.com' over the network...
Sent message to: 'mad_max@ya.com'. Message body: 'Hey! This is Anna's friend Josh. Can you do me a favor and like this post [link]?'
Facebook: Loading profile 'catwoman@yahoo.com' over the network...
Sent message to: 'catwoman@yahoo.com'. Message body: 'Hey! This is Anna's friend Josh. Can you do me a favor and like this post [link]?'

Iterating over coworkers...

Facebook: Loading 'coworkers' list of 'anna.smith@bing.com' over the network...
Facebook: Loading profile 'sam@amazon.com' over the network...
Sent message to: 'sam@amazon.com'. Message body: 'Hey! This is Anna's boss Jason. Anna told me you would be interested in [link].'
```


# 访问者模式
## ASM
ASM，对class内部文件进行分开访问不同数据结构，比如访问version、field、method等
```java
package com.mashibing.dp.ASM;  
  
import org.objectweb.asm.ClassReader;  
import org.objectweb.asm.ClassVisitor;  
import org.objectweb.asm.FieldVisitor;  
import org.objectweb.asm.MethodVisitor;  
  
import java.io.IOException;  
  
import static org.objectweb.asm.Opcodes.ASM4;  
  
public class ClassPrinter extends ClassVisitor {  
    public ClassPrinter() {  
        super(ASM4);  
    }  
  
    @Override  
    public void visit(int version, int access, String name, String signature, String superName, String[] interfaces) {  
        System.out.println(name + " extends " + superName + "{" );  
    }  
  
    @Override  
    public FieldVisitor visitField(int access, String name, String descriptor, String signature, Object value) {  
        System.out.println("    " + name);  
        return null;    }  
  
    @Override  
    public MethodVisitor visitMethod(int access, String name, String descriptor, String signature, String[] exceptions) {  
        System.out.println("    " + name + "()");  
        return null;    }  
  
    @Override  
    public void visitEnd() {  
  
        System.out.println("}");  
    }  
  
    public static void main(String[] args) throws IOException {  
        ClassPrinter cp = new ClassPrinter();  
        //ClassReader cr = new ClassReader("java.lang.Runnable");  
        ClassReader cr = new ClassReader(  
                ClassPrinter.class.getClassLoader().getResourceAsStream("com/mashibing/dp/ASM/T1.class"));  
  
  
        cr.accept(cp, 0);  
    }  
}
```

### T1.class
```java
/**  
 * 光标必须位于类体内，View-Show ByteCode  
 */  
public class T1 {  
    int i = 0;  
    public void m() {  
        int j=1;  
    }  
  
}
```

### ClassWriterTest.java
```java
package com.zhenksoft.architect.dp.ASM;  
  
  
import org.objectweb.asm.ClassWriter;  
import static org.objectweb.asm.Opcodes.*;  
  
/**  
 * @author JiangQH  
 * @create 2020-09-16 19:48:41  
 * <p>  
 * 没有源码的情况下生产class文件  
 */  
public class ClassWriterTest {  
    public static void main(String[] args) {  
        ClassWriter cw = new ClassWriter(0);  
        cw.visit(V1_5, ACC_PUBLIC + ACC_ABSTRACT + ACC_INTERFACE,  
                "pkg/Comparable", null, "java/lang/Object",  
                null);  
        cw.visitField(ACC_PUBLIC + ACC_FINAL + ACC_STATIC, "LESS", "I",  
                null, new Integer(-1)).visitEnd();  
        cw.visitField(ACC_PUBLIC + ACC_FINAL + ACC_STATIC, "EQUAL", "I",  
                null, new Integer(0)).visitEnd();  
        cw.visitField(ACC_PUBLIC + ACC_FINAL + ACC_STATIC, "GREATER", "I",  
                null, new Integer(1)).visitEnd();  
        cw.visitMethod(ACC_PUBLIC + ACC_ABSTRACT, "compareTo",  
                "(Ljava/lang/Object;)I", null, null).visitEnd();  
        cw.visitEnd();  
        byte[] b = cw.toByteArray();  
  
        MyClassloader myClassloader = new MyClassloader();  
        Class c = myClassloader.defineClass("pkg.Comparable", b);  
        System.out.println(c.getMethods()[0].getName());  
    }  
  
    private static class MyClassloader extends ClassLoader {  
        public Class defineClass(String name, byte[] b) {  
            return defineClass(name, b, 0, b.length);  
        }  
    }  
}
```

# 空对象模式
## hamcrest匹配测试神器
![[空对象模式-hamcrest测试神器.png]]



```java
public abstract class DiagnosingMatcher<T> extends BaseMatcher<T> {  
  
    @Override  
    public final boolean matches(Object item) {
        // 空实现的使用
        return matches(item, Description.NONE);  
    }  
  
    @Override  
    public final void describeMismatch(Object item, Description mismatchDescription) {  
        matches(item, mismatchDescription);  
    }  
  
    protected abstract boolean matches(Object item, Description mismatchDescription);  
}
```
